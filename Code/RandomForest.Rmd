---
title: "RandomForest"
---
# Load Data and Library
```{r Load Data}
load(paste0(here::here(), "/Data/airbnb.RData"))
source("helper_function.R")
set.seed(2023)

library(purrr)
library(tidyverse)
library(caret)
library(randomForest)
```

# Feature Selection
```{r}
# Tunning mtry
mtry <- tuneRF(airbnb_train %>% select(-country_destination) , airbnb_train$country_destination, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)

rf <- randomForest(country_destination ~., data = airbnb_train, importance=TRUE, ntree = 500, mtry = best.m)
varImpPlot(rf)
rf
```



# Random Forest

```{r}
# Subset the for model code, choest testing the the first fold
subst_list <- extract_folds(airbnb_train, 1, folds, test = TRUE)
train <- subst_list$train
test <- subst_list$test
rm(subst_list)
```

```{r}
# Tunning mtry
mtry <- tuneRF(train %>% select(-country_destination) , train$country_destination, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]

```
```{r}
rf <- randomForest(country_destination ~., data = train, importance=TRUE, ntree = 500, mtry = best.m)
rf_pred <- predict(rf,type = "prob", newdata = test)
pred_interval <- CategoryPredInterval(rf_pred, test$country_destination %>% levels())
# table(test$country_destination, pred_interval$pred50)
# table(test$country_destination, pred_interval$pred80)
mis_class <- lapply(pred_interval, get_misclass_rate, actual = test$country_destination)

```

```{r}
randomforest_model <- function(training, holdout) {
  # Tunning mtry
  mtry <- tuneRF(training %>% select(-country_destination) , training$country_destination, ntreeTry=500,
                 stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
  best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
  # Fit Model & Make Prediction
  rf <- randomForest(country_destination ~., data = training, importance=TRUE, ntree = 500, mtry = best.m)
  rf_pred <- predict(rf,type = "prob", newdata = holdout)
  # Extract Prediction Interval, misclassification rate, AUC
  pred_interval <- CategoryPredInterval(rf_pred, holdout$country_destination %>% levels())
  # table(holdout$country_destination, pred_interval$pred50)
  # table(holdout$country_destination, pred_interval$pred80)
  mis_class <- lapply(pred_interval, get_misclass_rate, actual = holdout$country_destination)
  
  return(list(model = rf), pred = rf_pred, pred_interval = pred_interval, mis_class = mis_class)
}


```


```{r}
lapply(as.list(1:5), function(t){
  subst_list <- extract_folds(airbnb_train, t, folds, test = TRUE)
  train <- subst_list$train
  test <- subst_list$test
  return(randomforest_model(train, test))
})
```

