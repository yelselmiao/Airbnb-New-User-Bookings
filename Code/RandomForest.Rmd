---
title: "RandomForest"
---
File description:
- Perform Random Forest Model Training and Fitting for 4 submodels
  - Full model
  - Subseted model through Recursive Feature Selection
  - Undersampling model
  - Oversampling model
- Calculated roc and interval score values for the best model

# Load Data and Library
```{r Load Data}
load(paste0(here::here(), "/Data/airbnb_cleaned.RData"))
source("helper_function.R")
source("modeling_functions.R")
set.seed(2023)

library(purrr)
library(tidyverse)
library(caret)
library(randomForest)
library(pROC)

airbnb_data <- airbnb_cleaned
rm(airbnb_cleaned)
```



```{r}
# Each model take about 30 mins to run, 2 hr to run the whole thing
rf_full_result <- rf_5fold_cross(airbnb_data, folds, type ="full")
# rf_sub_result <- rf_5fold_cross(airbnb_data, folds, type ="sub")
rf_over_full_result <- rf_5fold_cross(airbnb_data, folds, type ="over")
rf_under_full_result <- rf_5fold_cross(airbnb_data, folds, type ="under")

save(rf_full_result, rf_under_full_result, rf_over_full_result,
     file = paste0(here::here(), "/Data/rf_model_objects.RData"))
```


```{r Get Misclassification Rate}
load(paste0(here::here(), "/Data/rf_model_objects.RData"))
# mis_class_sub <- sapply(rf_sub_result, "[", "mis_class")
mis_class_ful <- sapply(rf_full_result, "[", "mis_class")
mis_class_ful_under <- sapply(rf_under_full_result, "[", "mis_class")
mis_class_ful_over <- sapply(rf_over_full_result, "[", "mis_class")

rf_misclass <- data.frame(full_50 = sapply(mis_class_ful, "[", "pred50") %>% unlist(),
                          # sub_50 = sapply(mis_class_sub, "[", "pred50") %>% unlist(),
                          under_50 = sapply(mis_class_ful_under, "[", "pred50") %>% unlist(),
                          over_50 = sapply(mis_class_ful_over, "[", "pred50") %>% unlist(),
                          full_80 = sapply(mis_class_ful, "[", "pred80") %>% unlist(),
                          # sub_80 = sapply(mis_class_sub, "[", "pred80") %>% unlist(),
                          under_80 = sapply(mis_class_ful_under, "[", "pred80") %>% unlist(),
                          over_80 = sapply(mis_class_ful_over, "[", "pred80") %>% unlist()
                          )
rownames(rf_misclass) <- c("Fold1", "Fold2", "Fold3", "Fold4", "Fold5")

rf_misclass["avg",] <- colMeans(rf_misclass)
```

```{r AUC}
# Obtain the AUC of the best model -- oversampling model
auc <- lapply(as.list(1:5), function(t){
  test_ROC <- multiclass.roc(extract_folds(df = airbnb_data, target_fold = t, fold_idx = folds)$country_destination, 
                  rf_over_full_result[[t]]$pred[,2]) 
  test_ROC$auc
  
})

auc <- auc %>% unlist()
auc <- c(auc, mean(auc))
auc
```

```{r Interval Score}
# Calculate the interval score for the best model
IS50 <- lapply(as.list(1:5), function(fold){
  IS <- ComputeIntervalScore(rf_over_full_result[[fold]]$pred,
                             extract_folds(airbnb_data, fold, folds)$country_destination,
                             0.5) }) %>% unlist()
IS50 <- c(IS50, mean(IS50))

IS80 <- lapply(as.list(1:5), function(fold){
  IS <- ComputeIntervalScore(rf_over_full_result[[fold]]$pred,
                             extract_folds(airbnb_data, fold, folds)$country_destination,
                             0.2) }) %>% unlist()
IS80 <- c(IS80, mean(IS80))

IS50
IS80
```


## Save rf_model_realvant info
```{r}
save(rf_full_result, rf_sub_result, rf_under_full_result, rf_over_full_result,
     file = paste0(here::here(), "/Data/rf_model_results.RData"))
```

```{r}
save(rf_misclass, auc, file = paste0(here::here(), "/Data/rf_results.RData"))
```



