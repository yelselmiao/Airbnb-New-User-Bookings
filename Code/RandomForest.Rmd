---
title: "RandomForest"
---
# Load Data and Library
```{r Load Data}
load(paste0(here::here(), "/Data/airbnb.RData"))
source("helper_function.R")
source("modeling_functions.R")
set.seed(2023)

library(purrr)
library(tidyverse)
library(caret)
library(randomForest)
library(pROC)
```

# Feature Selection
```{r}
# Tunning mtry
mtry <- tuneRF(airbnb_train %>% select(-country_destination) , airbnb_train$country_destination, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)

rf <- randomForest(country_destination ~., data = airbnb_train, importance=TRUE, ntree = 500, mtry = best.m)
varImpPlot(rf)
rf
```



# Random Forest

```{r}
# Subset the for model code, choest testing the the first fold
airbnb_data_sub <- airbnb_train %>% 
  select(signup_method, log_unique_actionTrp, date_account_created, log_total_action, date_first_active, AppleCate, first_browser, OtherCate,
         country_destination)

subst_list <- extract_folds(airbnb_train, 1, folds, test = TRUE)
train <- subst_list$train
test <- subst_list$test
rm(subst_list)
```


```{r}
# Tunning mtry
mtry <- tuneRF(train %>% select(-country_destination) , train$country_destination, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]

```

```{r}
samplesize <- (((train %>% group_by(country_destination) %>% tally())$n)/3 * 2) %>% round()
samplesize <-  rep(samplesize[1],3)
names(samplesize) <- c("other", "US", "NDF")
rf <- randomForest(country_destination ~., data = train, importance=TRUE, ntree = 500, mtry = best.m,
                   strata =train$country_destination, samplesize = samplesize)
rf_pred <- predict(rf,type = "prob", newdata = test)
pred_interval <- CategoryPredInterval(rf_pred, test$country_destination %>% levels())
# table(test$country_destination, pred_interval$pred50)
# table(test$country_destination, pred_interval$pred80)
mis_class <- lapply(pred_interval, get_misclass_rate, actual = test$country_destination)

```




```{r}
rf_over_full_result <- lapply(as.list(1:5), function(t){
  subst_list <- extract_folds(airbnb_train, t, folds, test = TRUE)
  train <- subst_list$train
  test <- subst_list$test
  return(randomforest_model(train, test))
})
```

```{r}
names(rf_over_full_result) <- lapply(as.list(1:5), function(t){paste0("fold", as.character(t))}) %>% unlist()
sapply(rf_under_full_result, "[", "mis_class")
```

```{r}
# rf_sub_under_result <- lapply(as.list(1:4), function(t){
#   subst_list <- extract_folds(airbnb_data_sub, t, folds, test = TRUE)
#   train <- subst_list$train
#   test <- subst_list$test
#   return(randomforest_model(train, test, "under"))
# })

rf_sub_result <- rf_5fold_cross(airbnb_train, folds, type ="sub")
rf_over_full_result <- rf_5fold_cross(airbnb_train, folds, type ="over")
```

```{r}
names(rf_sub_under_result) <- lapply(as.list(1:4), function(t){paste0("fold", as.character(t))}) %>% unlist()
sapply(rf_sub_under_result, "[", "mis_class")
```



```{r}
load(paste0(here::here(), "/Data/rf_model_results.RData"))
mis_class_sub <- sapply(rf_sub_result, "[", "mis_class")
mis_class_ful <- sapply(rf_full_result, "[", "mis_class")
mis_class_ful_under <- sapply(rf_under_full_result, "[", "mis_class")
mis_class_ful_over <- sapply(rf_over_full_result, "[", "mis_class")

rf_misclass <- data.frame(full_50 = sapply(mis_class_ful, "[", "pred50") %>% unlist(),
                          sub_50 = sapply(mis_class_sub, "[", "pred50") %>% unlist(),
                          under_50 = sapply(mis_class_ful_under, "[", "pred50") %>% unlist(),
                          over_50 = sapply(mis_class_ful_over, "[", "pred50") %>% unlist(),
                          full_80 = sapply(mis_class_ful, "[", "pred80") %>% unlist(),
                          sub_80 = sapply(mis_class_sub, "[", "pred80") %>% unlist(),
                          under_80 = sapply(mis_class_ful_under, "[", "pred80") %>% unlist(),
                          over_80 = sapply(mis_class_ful_over, "[", "pred80") %>% unlist()
                          )
rownames(rf_misclass) <- c("Fold1", "Fold2", "Fold3", "Fold4", "Fold5")

rf_misclass["avg",] <- colMeans(rf_misclass)
```

## Save rf_model_realvant info
```{r}
save(rf_full_result, rf_sub_result, rf_under_full_result, rf_over_full_result,
     file = paste0(here::here(), "/Data/rf_model_results.RData"))
```

```{r}
save(rf_misclass, file = paste0(here::here(), "/Data/rf_results.RData"))
```

```{r}
test <- rf_over_full_result[[1]]

test_test <- extract_folds(df = airbnb_train, target_fold = 1, fold_idx = folds)

test_ROC <- roc(test_test$country_destination, test$pred[,2])
test_ROC$auc
```


