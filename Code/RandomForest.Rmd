---
title: "RandomForest"
---
# Load Data and Library
```{r Load Data}
load(paste0(here::here(), "/Data/airbnb.RData"))
source("helper_function.R")
source("modeling_functions.R")
set.seed(2023)

library(purrr)
library(tidyverse)
library(caret)
library(randomForest)
library(pROC)
```



```{r}
# Each model take about 30 mins to run, 2 hr to run the whole thing
rf_full_result <- rf_5fold_cross(airbnb_train, folds, type ="full")
rf_sub_result <- rf_5fold_cross(airbnb_train, folds, type ="sub")
rf_over_full_result <- rf_5fold_cross(airbnb_train, folds, type ="over")
rf_over_under_result <- rf_5fold_cross(airbnb_train, folds, type ="under")
```


```{r Get Misclassification Rate}
#  load(paste0(here::here(), "/Data/rf_model_results.RData"))
mis_class_sub <- sapply(rf_sub_result, "[", "mis_class")
mis_class_ful <- sapply(rf_full_result, "[", "mis_class")
mis_class_ful_under <- sapply(rf_under_full_result, "[", "mis_class")
mis_class_ful_over <- sapply(rf_over_full_result, "[", "mis_class")

rf_misclass <- data.frame(full_50 = sapply(mis_class_ful, "[", "pred50") %>% unlist(),
                          sub_50 = sapply(mis_class_sub, "[", "pred50") %>% unlist(),
                          under_50 = sapply(mis_class_ful_under, "[", "pred50") %>% unlist(),
                          over_50 = sapply(mis_class_ful_over, "[", "pred50") %>% unlist(),
                          full_80 = sapply(mis_class_ful, "[", "pred80") %>% unlist(),
                          sub_80 = sapply(mis_class_sub, "[", "pred80") %>% unlist(),
                          under_80 = sapply(mis_class_ful_under, "[", "pred80") %>% unlist(),
                          over_80 = sapply(mis_class_ful_over, "[", "pred80") %>% unlist()
                          )
rownames(rf_misclass) <- c("Fold1", "Fold2", "Fold3", "Fold4", "Fold5")

rf_misclass["avg",] <- colMeans(rf_misclass)
```

```{r AUC}
# Obtain the AUC of the best model -- oversampling model
auc <- lapply(as.list(1:5), function(t){
  test_ROC <- multiclass.roc(extract_folds(df = airbnb_train, target_fold = t, fold_idx = folds)$country_destination, 
                  rf_over_full_result[[t]]$pred[,2]) 
  test_ROC$auc
  
})

auc <- auc %>% unlist()
auc <- c(auc, mean(auc))
auc
```


## Save rf_model_realvant info
```{r}
save(rf_full_result, rf_sub_result, rf_under_full_result, rf_over_full_result,
     file = paste0(here::here(), "/Data/rf_model_results.RData"))
```

```{r}
save(rf_misclass, auc, file = paste0(here::here(), "/Data/rf_results.RData"))
```



