---
title: "R Notebook"
author: Shuyi Tan
output: github_document
editor_options: 
  chunk_output_type: inline
---

```{r Library}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(mice))
source('helper_function_cleaning.R')
```

```{r Load Data, echo=TRUE}
data_path <- paste0(here::here(), '/Data/')
countries <- read.csv(paste0(data_path,"countries.csv"))
demo <- read.csv(paste0(data_path,"age_gender_bkts.csv"))   
# session <- read.csv(paste0(data_path,"sessions.csv"))
df <- read.csv(paste0(data_path,"train_users_2.csv"))
```

Varaibles in `df`: 
- id: user id  
- date_account_created: the date of account creation  
- timestamp_first_active: timestamp of the first activity, note that it can be earlier than  
(date_account_created or date_first_booking because a user can search before signing up)
- date_first_booking: date of first booking  
- gender  
- age  
- signup_method  
- signup_flow: the page a user came to signup up from  
- language: international language preference  
- affiliate_channel: what kind of paid marketing  
- affiliate_provider: where the marketing is e.g. google, craigslist, other  
- first_affiliate_tracked: whats the first marketing the user interacted with before the signing up  
- signup_app  
- first_device_type  
- first_browser  
- country_destination: response var  

```{r missing values in age and gender}
# 'unknow' is actually missing data 
df[df=="" | df == "-unknown-"]<-NA
######################################################## Age 88,898 missing vale (41.6%)

# Age abnormal case 1: the data is collected in 2015, accrording to the Airbnb term of use, the minimum age required for account creation is 18, so I assume ages < 18 are faulty inputs

# Age abnormal case 2: similarily, for those who wrong entered year as age, if it's greater than 2015-18 = 1997, it;s faulty (750 rows)

# convert these problematic age entries as NA
df$age[df$age < 18 | df$age > 1997] <- NA

# convert problematic year entry to age
df <- df %>% 
  mutate(true_age = ifelse(age > 1000, 2015 - age, age))
  
######################################################## Gender (95688 missing value) - (44.8%)
nrow(df %>% 
  filter(is.na(gender))) 


# since it's far beyond acceptable proportion of missing value in terms of age and gender, I think a complete case analysis is perhaps more reasonable than imputed data analysis (will verify)
df_cc <- df %>% 
  filter(!is.na(gender) & !is.na(age))
```


```{r visualize missingness in gender and age, fig.width=8, fig.height=3}
destination_prop_plot(df_cc)
destination_prop_plot(df)

df_miss <- df %>% 
  mutate(miss = ifelse(!is.na(gender) & !is.na(age), 0, 1),
         miss = as.factor(miss)) 

chisq.test(df_miss$miss, df_miss$country_destination)
```

2. page 4: column 2 header should be "#missing(%)"
what does complete-case mean for gender or age?
Does this mean you keep cases with both gender and age non-missing?
For missing on "first-browser" can you make missing a separate category?

3. page 7: multiple lines for a user in the original sessions database converted to actiontriplet1, actiontriplet2, ... in the cleaned sessions database.
If userid is a field, does this mean that there are at most 20 actiontriplets?

4. page 9: response variable, not responsible variable.
I think you will have to merge the categories with small counts.

5. pages 11, 12, 13, 14: more than half 0s for some countries?
Sqrt transform for y-axis would be better?

6. page 16: for these features, categories with small counts should be merged with other categories.

7. Unbalanced classes will cause difficulties.
After reducing the number of classes for the response variable, maybe naive Bayes can be used. Please look at default-naiveBayes.pdf at the course web site for density estimation for continuous variables after transforming away extreme skewness.

```{r check data missing for other char columns}
map(df, ~sum(is.na(.))/nrow(df))
map(df_cc, ~sum(is.na(.))/nrow(df_cc))


# date_first_booking: 124543 (47.9%) 
# consider drop this column 

# first_affiliate_tracked: 6065 (1.6%)
# impute it in next chunk 


# first_browser: 27266 (9.8%)
# treat missingness as a separate category 
```

```{r impute first_affiliate_tracked, echo = TRUE}
df_cc_init <- mice(df_cc, maxit = 0)
meth <- df_cc_init$meth
meth[!names(meth) %in% c("first_affiliate_tracked")] <- ""
df_cc_imp_5 <- mice(df_cc, meth = meth, seed = 1234, m = 5)
df_cc_imp <- complete(df_cc_imp_5)
```

```{r convert data col & convert char to factor, warning = FALSE}
df_cc_imp <- df_cc_imp %>%
  mutate(
    date_first_active = as.Date(ymd_hms(timestamp_first_active),'%Y-%m-%d'),
    date_account_created = as.Date(date_account_created, '%Y-%m-%d'),
    date_first_booking = as.Date(date_first_booking, '%Y-%m-%d')
  ) %>% 
  relocate(date_first_active, .before = date_first_booking) %>%
  select(-timestamp_first_active) 
```

```{r check factor cols (contingency table)}
# contingency table of each factor column
print(category_count(df_cc_imp))

# combine categories with extremely small counts 
df_cleaned <- category_comb(df_cc_imp)


# further merge categories
df_cleaned <- category_comb_II(df_cleaned)


# re-factor the categories 
df_cleaned <- df_cleaned %>% 
  mutate_if(is.character, factor) %>% 
  mutate_if(is.factor, factor)
  
# check the count of each category in each categorical variable again 
category_count(df_cleaned)
```


```{r sort desctinations}
# sort the desctinations
df_cleaned <- des_sorter(df_cleaned)

# check prop of NDF and continents                                   
df_cleaned %>%
  select(NDF,country_destination, continent_des) %>%
  map(function(x)
    table(x))                                                                
```


```{r Save cleaned data as csv}
# write.csv(df_cleaned, paste0(here::here(), '/Data/users_train_cleaned.csv'))
```



















