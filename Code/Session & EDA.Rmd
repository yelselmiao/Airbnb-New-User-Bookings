---
title: "Airbnb New User"
---

Airbnb challenges you to predict in which country a new user will make his or her first booking

In this challenge, you are given a list of users along with their demographics, web session records, and some summary statistics. You are asked to predict which country a new user's first booking destination will be. All the users in this dataset are from the USA.

There are 12 possible outcomes of the destination country: 'US', 'FR', 'CA', 'GB', 'ES', 'IT', 'PT', 'NL','DE', 'AU', 'NDF' (no destination found), and 'other'. Please note that 'NDF' is different from 'other' because 'other' means there was a booking, but is to a country not included in the list, while 'NDF' means there wasn't a booking.

The training and test sets are split by dates. In the test set, you will predict all the new users with first activities after 7/1/2014 (note: this is updated on 12/5/15 when the competition restarted). In the sessions dataset, the data only dates back to 1/1/2014, while the users dataset dates back to 2010. 

https://www.kaggle.com/c/airbnb-recruiting-new-user-bookings/data

### Data Wrangling and Cleanning -> Refer to Sheyi -> cleaned Data 
```{r library}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ggridges))
```


```{r Load Data, message=FALSE, warning=FALSE}
data_path <- paste0(here::here(), '/Data/')
users_train <- read.csv(paste0(data_path,"df_cleaned.csv"))
# users_train <- read_csv("data/train_users_2.csv")
age_gender_bkts <- read.csv(paste0(data_path,"age_gender_bkts.csv"))   
sessions <- read.csv(paste0(data_path,"sessions.csv"), na = c("", "NA"))
countries <- read.csv(paste0(data_path,"countries.csv"))
```


### Clean session
Combine action, action_type, action_detail as action group

#### Action Group
```{r Missing Value Handling, message=FALSE}
#' Only keep the session data relavant to test & train set, key = user_id
sessions <- sessions %>% filter(user_id %in% users_train$id)

#' Deal with Missing Values
#' Fill na is time elpse with 0 
#' Change -unknown- level in action, action_type, action_detail to NA
#' Drop rows for which "user_id == NA"
sessions <- sessions %>% mutate(secs_elapsed = replace_na(secs_elapsed, 0)) %>% drop_na(user_id)

```


```{r Action Group Frequency Encoding}
# # subset session for testing
# sessions = sessions %>% head(nrow(sessions)/500)

# # Frequency Encoding, Not used
# # Create Action Group
# session_by_action <- sessions %>% group_by(action, action_type, action_detail) %>% 
#   summarise(freq_count = n(), .groups = "keep") %>% ungroup() %>% 
#   mutate(action_group = paste(action, action_type, action_detail, sep = "/")) %>%
#   select(action_group, freq_count)
# 
# # Frequency encoding on session
# sessions <- sessions %>% group_by(action, action_type, action_detail) %>% 
#   mutate(action_group = paste(action, action_type, action_detail, sep = "/")) %>% 
#   ungroup() %>% select(-c(action, action_type, action_detail)) %>% 
#   group_by(user_id, action_group) %>% 
#   left_join(session_by_action, by = "action_group") %>% ungroup() %>%
#   select(-action_group)

# Compute the number unique actions (action_group) each user performed
num_diff_actions <- sessions %>% 
  mutate(action_group = paste(action, action_type, action_detail, sep = "/")) %>%
  select(user_id, action_group) %>% 
  group_by(user_id) %>% summarise(num_diff_action = n_distinct(action_group))

# Compute the number different of actions each user performed in total
actions <- sessions %>% 
  group_by(user_id) %>% summarise(total_action = n()) %>% 
  left_join(num_diff_actions)
rm(num_diff_actions)

#' Plot distribution of total action, it is found that the original data is heavily left skewed
#' A log transformation is then applied as a solution
actions %>% ggplot(aes(x = total_action)) + geom_histogram()
actions %>% ggplot(aes(x = log(total_action))) + geom_histogram()

actions %>% ggplot(aes(x = num_diff_action)) + geom_histogram()
actions %>% ggplot(aes(x = log(num_diff_action))) + geom_histogram()

# Apply log transformation
actions <- actions %>% mutate(log_total_action = log(total_action),
                              log_unique_actionTrp = log(num_diff_action),
                              total_action = NULL, num_diff_action = NULL)

```


#### Device
```{r}
# Category count check
# sessions %>% ggplot(aes(device_type)) +geom_bar()

# Combine device type categories into four main ones: Windows, Android, Apple
orgn_cate <- sessions$device_type %>% factor() %>% levels()
new_cate <- c("Other", rep("Android", 3), "Windows", rep("Apple",3), "Other", "Apple", "Android",
              "Android", rep("Windows", 2))
devices <- sessions %>% mutate(devices = plyr::mapvalues(device_type, from = orgn_cate, to = new_cate), 
                               device_type = NULL) %>%
  group_by(user_id, devices) %>% summarise(total_secs = sum(secs_elapsed), .groups = "keep") %>% 
  ungroup() %>% 
  pivot_wider(names_from = devices, values_from = total_secs, id_cols = user_id, values_fill = 0)
```


```{r message=FALSE}
devices %>% ggplot(aes(x = Apple)) + geom_histogram()
devices %>%  ggplot(aes(x = (Apple^(1/3)))) + geom_histogram()

devices %>% ggplot(aes(x = Android)) + geom_histogram()
# devices %>% ggplot(aes(x = log(Android))) + geom_histogram()
devices %>% ggplot(aes(x = (Android^(1/3)))) + geom_histogram()

devices %>% ggplot(aes(x = Windows)) + geom_histogram()
# devices %>% ggplot(aes(x = log(Windows))) + geom_histogram()
devices %>% ggplot(aes(x = (Windows^(1/3)))) + geom_histogram()

devices %>% ggplot(aes(x = Other)) + geom_histogram()
devices %>% ggplot(aes(x = log(Other))) + geom_histogram() # bimodal distribution -> binning
# devices %>% filter(Other != 0) %>% ggplot(aes(x = (Other^(1/3)))) + geom_histogram()

```

```{r}
device_trans <- devices %>% mutate(cbrt_Apple = Apple^ (1/3), cbrt_Android = Android^(1/3),
                                   cbrt_Windows = Windows^(1/3)) %>% 
  select(-c(Apple, Android, Windows))

otherBreaks <- c(-1, exp(8.5), max(devices$Other))
device_trans <- device_trans %>% mutate(OtherCate = cut(Other, otherBreaks)) %>% select(-Other)

# cbrt Breaks
cbrt_AppleBreaks <- c(-0.01, 0.01,
                      quantile(device_trans$cbrt_Apple[device_trans$cbrt_Apple != 0 ], 0.5),
                      max(device_trans$cbrt_Apple))
cbrt_AndroidBreaks <- c(-0.01, 0.01,
                        quantile(device_trans$cbrt_Android[device_trans$cbrt_Android != 0 ], 0.5),
                        max(device_trans$cbrt_Android))
cbrt_WindowsBreaks <- c(-0.01, 0.01,
                        quantile(device_trans$cbrt_Windows[device_trans$cbrt_Windows != 0 ], 0.5),
                        max(device_trans$cbrt_Windows))
# cbrt Binned
device_trans <- device_trans %>% mutate(AppleCate = cut(cbrt_Apple, cbrt_AppleBreaks),
                                        AndroidCate = cut(cbrt_Android, cbrt_AndroidBreaks),
                                        WindowsCate = cut(cbrt_Windows, cbrt_WindowsBreaks)) %>% 
  select(-c(cbrt_Apple, cbrt_Android, cbrt_Windows))

```



### Join Action & Device

```{r}
new_session <- full_join(actions, device_trans, by = "user_id")
```



### Join with user_train
```{r}
airbnb_train <- inner_join(users_train, new_session, by = c("id" = "user_id"))
```


## Airbnb transformation
```{r}
airbnb_train <- airbnb_train %>% filter(true_age < 95) %>% 
  mutate(log_age = log(true_age)) %>% 
  select(-c(X, id, date_first_booking, age, true_age))

```

### Save Data
```{r}
save(new_session, airbnb_train, file = paste0(data_path,"airbnb.RData"))
```

